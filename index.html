
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>Thu ti·ªÅn ƒëi·ªán</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; max-width: 800px; margin:auto; padding:20px; border-radius:10px; }
    input, button, textarea { margin: 5px; padding: 5px; font-size: 14px; }
    .input-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .input-group label {
        width: 150px;
        font-weight: bold;
    }
    .input-group input {
        flex: 1;
    }
    #hoaDon {
        width: 400px;
        min-height: 250px;
        border: 2px solid black;
        padding: 15px;
        white-space: normal;
        font-size: 18px;
        font-family: 'Times New Roman', serif;
        line-height: 1.2;
    }
    #hoaDon p { margin: 0; }
    #lichSuIn {
        width: 100%;
        height: 120px;
        font-size: 14px;
        white-space: nowrap;
        overflow-x: auto;
    }
    #lichSuThu {
        width: 250px;
        height: 150px;
    }
    #inButton {
        padding: 12px 24px;
        font-size: 18px;
        font-weight: bold;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    #inButton:hover {
        background-color: #45a049;
    }
    @media print {
        body * { visibility: hidden; }
        #hoaDon, #hoaDon * { visibility: visible; }
        #hoaDon { position: absolute; top: 0; left: 0; width: 100%; }
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
    <h2>Thu ti·ªÅn ƒëi·ªán</h2>
    <div class="row">
        <button onclick="document.getElementById('fileInput').click()" type="button">ƒê·∫©y d·ªØ li·ªáu</button>
        <input accept=".xlsx" id="fileInput" onchange="docFileExcel(event)" style="display:none" type="file"/>
    </div>
</div>

<div class="input-group">
  <label>Ng∆∞·ªùi thu ti·ªÅn</label>
  <input id="nguoiThuTien" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu"/>
</div>
<div class="input-group">
  <label>M√£ kh√°ch h√†ng</label>
  <input id="maKH" list="danhSachKH" onkeydown="if(event.key==='Enter'){timKiemMaKH()}" placeholder="(m·ª•c t√¨m ki·∫øm)"/>
  <datalist id="danhSachKH"></datalist>
  <button onclick="timKiemMaKH()" type="button">üîç</button>
</div>
<div class="input-group">
  <label>S·ªë ti·ªÅn</label>
  <input id="soTien" readonly/>
</div>
<div class="input-group">
  <label>T√™n KH</label>
  <input id="tenKH" readonly/>
</div>

<div style="display:flex; gap:10px; align-items:flex-start; margin-top:10px;">
  <div style="flex:1;">
    <div id="hoaDon">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
  </div>
  <div style="display:flex; flex-direction:column; gap:10px;">
    <button id="inButton" onclick="inHoaDon()">In</button>
    <label><b>L·ªãch s·ª≠ thu</b></label>
    <textarea id="lichSuThu" readonly></textarea>
    <button onclick="xuatLichSu('thu')">Xu·∫•t l·ªãch s·ª≠</button>
  </div>
</div>

<div class="row">
  <div style="flex: 1;">
    <label>L·ªãch s·ª≠ in</label><br/>
    <textarea id="lichSuIn" readonly></textarea><br/>
    <button onclick="xuatLichSu('in')" type="button">Xu·∫•t l·ªãch s·ª≠</button>
  </div>
</div>

<button onclick="xuatLichSuExcel()" type="button">Xu·∫•t Excel</button>
<button onclick="xoaLichSu()" type="button">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>

<script>
let duLieu = [];
let lichSuIn = JSON.parse(localStorage.getItem("lichSuIn")) || [];
let lichSuThu = JSON.parse(localStorage.getItem("lichSuThu")) || [];

function formatVND(number) {
  return Number(number).toLocaleString('vi-VN') + ' ‚Ç´';
}

function timKiemMaKH() {
  const maKH = document.getElementById("maKH").value.trim();
  const kh = duLieu.find(row => row.MA_KHTT === maKH);
  if (kh) {
    document.getElementById("tenKH").value = kh.TEN_KHTT;
    document.getElementById("soTien").value = kh.TONG_NOP;
    hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, kh.TONG_NOP);

    // Ghi l·∫°i v√†o l·ªãch s·ª≠ thu
    const soTien = Number(kh.TONG_NOP) + 2000;
    const thoiGian = new Date().toLocaleString();
    lichSuThu.push({ maKH: kh.MA_KHTT, tenKH: kh.TEN_KHTT, soTien, thoiGian });
    localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));
    capNhatLichSu();
  } else {
    document.getElementById("hoaDon").innerText = "[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]";
  }
}


function hienThiHoaDon(maKH, tenKH, soTien) {
  const nguoiThu = document.getElementById("nguoiThuTien").value || "-";
  const phi = 2000;
  const tong = Number(soTien) + phi;
  const now = new Date();
  const ngay = now.toLocaleDateString('vi-VN');
  const gio = now.toTimeString().split(' ')[0];
  const thoiGian = `Ng√†y ${ngay}, Gi·ªù ${gio}`;
  const noiDung = `
    <div style="text-align:center; font-weight:bold;">BI√äN LAI NH·∫¨N TI·ªÄN CHUY·ªÇN KHO·∫¢N</div>
    <p>M√£ KH: ${maKH}</p>
    <p>T√™n KH: ${tenKH}</p>
    <p>S·ªë Ti·ªÅn: ${formatVND(soTien)}</p>
    <p>Ph√≠: ${formatVND(phi)}</p>
    <p>T·ªïng Ti·ªÅn: ${formatVND(tong)}</p>
    <p>Ng∆∞·ªùi thu ti·ªÅn: ${nguoiThu}</p>
    <div style="text-align:center; font-weight:bold;">ƒê√É NH·∫¨N TI·ªÄN</div>
    <p>${thoiGian}</p>
    <div id="maQR" style="text-align:center; margin-top:10px;"></div>
  `;
  document.getElementById("hoaDon").innerHTML = noiDung.trim();

  // T·∫°o m√£ QR theo chu·∫©n EVN
const qrData = taoQR_EMVCo(maKH, soTien);
new QRCode(document.getElementById("maQR"), {
  text: qrData,
  width: 120,
  height: 120
});

function inHoaDon() {
  const maKH = document.getElementById("maKH").value;
  const tenKH = document.getElementById("tenKH").value;
  const soTien = Number(document.getElementById("soTien").value || 0);
  hienThiHoaDon(maKH, tenKH, soTien);
  lichSuIn.push({ maKH, tenKH, soTien: soTien + 2000, thoiGian: new Date().toLocaleDateString('vi-VN') });
  localStorage.setItem("lichSuIn", JSON.stringify(lichSuIn));
  capNhatLichSu();
  setTimeout(() => { window.print(); }, 0);
}

function capNhatLichSu() {
  const inText = lichSuIn.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  const thuText = lichSuThu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  document.getElementById("lichSuIn").value = inText;
  document.getElementById("lichSuThu").value = thuText;
}

function xuatLichSu(loai) {
  const duLieu = loai === 'in' ? lichSuIn : lichSuThu;
  const text = duLieu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${item.soTien}`).join("\n");
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `lich_su_${loai}.txt`;
  a.click();
}

function xuatLichSuExcel() {
  const wb = XLSX.utils.book_new();

  const wsIn = XLSX.utils.json_to_sheet(lichSuIn);
  XLSX.utils.book_append_sheet(wb, wsIn, "L·ªãch S·ª≠ In");

  const wsThu = XLSX.utils.json_to_sheet(lichSuThu);
  XLSX.utils.book_append_sheet(wb, wsThu, "L·ªãch S·ª≠ Thu");

  XLSX.writeFile(wb, "lich_su.xlsx");
}

function docFileExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    duLieu = XLSX.utils.sheet_to_json(sheet);
    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(row => {
      const option = document.createElement("option");
      option.value = row.MA_KHTT;
      dataList.appendChild(option);
    });
    alert("ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!");
  };
  reader.readAsArrayBuffer(file);
}

function xoaLichSu() {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ kh√¥ng?")) {
    localStorage.removeItem("lichSuIn");
    localStorage.removeItem("lichSuThu");
    lichSuIn = [];
    lichSuThu = [];
    capNhatLichSu();
  }
}

window.onload = capNhatLichSu;
    // H√†m t√≠nh CRC16-CCITT (EMVCo y√™u c·∫ßu)
function crc16ccitt(str) {
    const crcTable = [
        0x0000, 0x1021, 0x2042, 0x3063, 0x4084, 0x50A5, 0x60C6, 0x70E7,
        0x8108, 0x9129, 0xA14A, 0xB16B, 0xC18C, 0xD1AD, 0xE1CE, 0xF1EF
    ];
    let crc = 0xFFFF;
    for (let i = 0; i < str.length; i++) {
        let c = str.charCodeAt(i);
        let da = ((crc >> 12) & 0xF) ^ (c >> 4);
        crc = (crc << 4) ^ crcTable[da & 0xF];
        crc &= 0xFFFF;
        da = ((crc >> 12) & 0xF) ^ (c & 0xF);
        crc = (crc << 4) ^ crcTable[da & 0xF];
        crc &= 0xFFFF;
    }
    return crc.toString(16).toUpperCase().padStart(4, "0");
}

// H√†m t·∫°o m√£ QR thanh to√°n VietQR chu·∫©n EMVCo
function taoQR_EMVCo(maKH, soTien) {
    const account = "11900168961";
    const bankCode = "970415"; // VietinBank (theo NAPAS)
    const merchantName = "EVN";
    const merchantCity = "HANOI";
    const currencyCode = "704"; // VND
    const description = `Thanh toan tien dien MAKH: ${maKH}`;
    const amount = Number(soTien).toFixed(0);

    function formatTag(id, value) {
        const len = value.length.toString().padStart(2, '0');
        return id + len + value;
    }

    const guiID = formatTag("00", "A000000727");
    const acquirerID = formatTag("01", bankCode);
    const accountInfo = formatTag("38", guiID + acquirerID + formatTag("02", account));

    const payload =
        formatTag("00", "01") +
        formatTag("01", "12") +  // QR ƒë·ªông
        accountInfo +
        formatTag("52", "0000") +  // Merchant Category Code
        formatTag("53", currencyCode) +
        formatTag("54", amount) +
        formatTag("58", "VN") +
        formatTag("59", merchantName) +
        formatTag("60", merchantCity) +
        formatTag("62", formatTag("01", description));

    const fullPayload = payload + "6304";
    const crc = crc16ccitt(fullPayload);
    return fullPayload + crc;
}

<script>
function taoQRVietQR(maKH, soTien) {
  const stk = "11900168961";
  const bic = "ICBVVNVX";
  const noiDung = `Thanh toan tien dien MAKH: ${maKH}`;
  const tongTien = Math.floor(soTien); // Lo·∫°i b·ªè ph√≠ 2000

  // EMVCo base fields
  const payloadFormat = "000201";
  const initMethod = "010212";
  const merchantAccount = "38" +
    "0010A000000727" +
    "0113" + bic +
    "0208" + stk;
  const mcc = "520483";           // Lo·∫°i h√¨nh d·ªãch v·ª•
  const currency = "5303704";     // VND
  const amount = "54" + tongTien.toString().length.toString().padStart(2, "0") + tongTien;
  const country = "5802VN";
  const addInfo = "62" + (18 + noiDung.length).toString().padStart(2, "0") + "0012" + noiDung;
  const crc = "6304"; // CRC placeholder

  return payloadFormat + initMethod + merchantAccount + mcc + currency + amount + country + addInfo + crc;
}
</script>

</body>
</html>
