<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Thu ti·ªÅn ƒëi·ªán</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px auto; background: #f0f0f0; max-width: 800px; padding: 20px; border-radius: 10px; }
    input, button, textarea { margin: 5px 0; padding: 8px; font-size: 14px; }
    .input-group { display: flex; align-items: center; margin-bottom: 10px; }
    .input-group label { width: 150px; font-weight: bold; }
    .input-group input { flex: 1; }
    button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
    }
    #themButton { background-color: #64B5F6; }
    #inButton { background-color: #4CAF50; }
    #inTatCaButton { background-color: #2196F3; }
    #xuatButton { background-color: #FF9800; }
    #xoaButton { background-color: #f44336; }
    #hoaDon {
      width: 100%;
      min-height: 250px;
      border: 2px solid black;
      padding: 15px;
      font-size: 16px;
      background: white;
      line-height: 1.4;
      font-family: 'Times New Roman', serif;
    }
    #hoaDon p { margin: 0; }
    textarea { width: 100%; height: 100px; resize: vertical; }
    @media print {
      body * { visibility: hidden; }
      #hoaDon, #hoaDon * { visibility: visible; }
      #hoaDon { position: absolute; top: 0; left: 0; width: 100%; }
    }
  </style>
</head>
<body>

<h2>Thu ti·ªÅn ƒëi·ªán</h2>

<!-- ƒê·∫©y d·ªØ li·ªáu -->
<div>
  <button onclick="document.getElementById('fileInput').click()">üì• ƒê·∫©y d·ªØ li·ªáu t·ª´ Excel</button>
  <input type="file" id="fileInput" accept=".xlsx" onchange="docFileExcel(event)" style="display:none"/>
</div>

<!-- Nh·∫≠p v√† t√¨m kh√°ch h√†ng -->
<div class="input-group">
  <label>Ng∆∞·ªùi thu ti·ªÅn</label>
  <input id="nguoiThuTien" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu"/>
</div>

<div class="input-group">
  <label>M√£ kh√°ch h√†ng</label>
  <input id="maKH" list="danhSachKH" onkeydown="if(event.key==='Enter'){timKiemMaKH()}" placeholder="Nh·∫≠p m√£ KH"/>
  <datalist id="danhSachKH"></datalist>
  <button onclick="timKiemMaKH()">üîç</button>
</div>

<div class="input-group">
  <label>S·ªë ti·ªÅn</label>
  <input id="soTien" readonly/>
</div>
<div class="input-group">
  <label>T√™n KH</label>
  <input id="tenKH" readonly/>
</div>

<!-- N√∫t x·ª≠ l√Ω -->
<button id="themButton" onclick="themVaoDanhSach()">‚ûï Th√™m v√†o danh s√°ch</button>
<button id="inTatCaButton" onclick="inTatCaHoaDon()">üñ®Ô∏è In t·∫•t c·∫£</button>

<h3>Danh s√°ch h√≥a ƒë∆°n ƒë√£ ch·ªçn</h3>
<ul id="danhSachHoaDon"></ul>
<p><strong>T·ªïng ti·ªÅn t·∫•t c·∫£ h√≥a ƒë∆°n: <span id="tongTienTatCa">0 ‚Ç´</span></strong></p>

<div>
  <div id="hoaDon">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
</div>

<!-- In ƒë∆°n l·∫ª -->
<button id="inButton" onclick="inHoaDon()">üñ®Ô∏è In h√≥a ƒë∆°n hi·ªán t·∫°i</button>

<!-- L·ªãch s·ª≠ -->
<h3>L·ªãch s·ª≠ giao d·ªãch</h3>
<div>
  <label><b>L·ªãch s·ª≠ thu:</b></label>
  <textarea id="lichSuThu" readonly></textarea>
  <button onclick="xuatLichSu('thu')">üìÑ Xu·∫•t TXT Thu</button>
</div>

<div>
  <label><b>L·ªãch s·ª≠ in:</b></label>
  <textarea id="lichSuIn" readonly></textarea>
  <button onclick="xuatLichSu('in')">üìÑ Xu·∫•t TXT In</button>
</div>

<!-- Xu·∫•t & X√≥a -->
<button id="xuatButton" onclick="xuatLichSuExcel()">üì§ Xu·∫•t Excel (2 sheet)</button>
<button id="xoaButton" onclick="xoaLichSu()">üóëÔ∏è X√≥a to√†n b·ªô l·ªãch s·ª≠</button>

<script>
let duLieu = [];
let lichSuIn = JSON.parse(localStorage.getItem("lichSuIn")) || [];
let lichSuThu = JSON.parse(localStorage.getItem("lichSuThu")) || [];
let hoaDonDaChon = [];

function formatVND(number) {
  return Number(number).toLocaleString('vi-VN') + ' ‚Ç´';
}

function docFileExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    duLieu = XLSX.utils.sheet_to_json(sheet);

    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(row => {
      const option = document.createElement("option");
      option.value = row.MA_KHTT;
      dataList.appendChild(option);
    });

    alert("ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!");
  };
  reader.readAsArrayBuffer(file);
}

function timKiemMaKH() {
  const maKH = document.getElementById("maKH").value.trim();
  const kh = duLieu.find(row => row.MA_KHTT === maKH);
  if (kh) {
    document.getElementById("tenKH").value = kh.TEN_KHTT;
    document.getElementById("soTien").value = kh.TONG_NOP;
    hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, kh.TONG_NOP);

    const soTien = Number(kh.TONG_NOP) + 2000;
    const thoiGian = new Date().toLocaleString();
    lichSuThu.push({ maKH: kh.MA_KHTT, tenKH: kh.TEN_KHTT, soTien, thoiGian });
    localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));
    capNhatLichSu();
  } else {
    document.getElementById("hoaDon").innerText = "[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]";
  }
}

function hienThiHoaDon(maKH, tenKH, soTien) {
  const nguoiThu = document.getElementById("nguoiThuTien").value || "-";
  const phi = 2000;
  const tong = Number(soTien) + phi;
  const now = new Date();
  const ngay = now.toLocaleDateString('vi-VN');
  const gio = now.toTimeString().split(' ')[0];
  const thoiGian = `Ng√†y ${ngay}, Gi·ªù ${gio}`;
  const noiDung = `
    <div style="text-align:center; font-weight:bold;">BI√äN LAI NH·∫¨N TI·ªÄN</div>
    <p>M√£ KH: ${maKH}</p>
    <p>T√™n KH: ${tenKH}</p>
    <p>S·ªë Ti·ªÅn: ${formatVND(soTien)}</p>
    <p>Ph√≠: ${formatVND(phi)}</p>
    <p>T·ªïng Ti·ªÅn: ${formatVND(tong)}</p>
    <p>Ng∆∞·ªùi thu ti·ªÅn: ${nguoiThu}</p>
    <div style="text-align:center; font-weight:bold;">ƒê√É NH·∫¨N TI·ªÄN</div>
    <p>${thoiGian}</p>
  `;
  document.getElementById("hoaDon").innerHTML = noiDung.trim();
}

function inHoaDon() {
  const maKH = document.getElementById("maKH").value;
  const tenKH = document.getElementById("tenKH").value;
  const soTien = Number(document.getElementById("soTien").value || 0);
  hienThiHoaDon(maKH, tenKH, soTien);
  lichSuIn.push({ maKH, tenKH, soTien: soTien + 2000, thoiGian: new Date().toLocaleDateString('vi-VN') });
  localStorage.setItem("lichSuIn", JSON.stringify(lichSuIn));
  capNhatLichSu();
  setTimeout(() => { window.print(); }, 0);
}

function themVaoDanhSach() {
  const maKH = document.getElementById("maKH").value.trim();
  const kh = duLieu.find(row => row.MA_KHTT === maKH);
  if (kh) {
    hoaDonDaChon.push(kh);
    capNhatDanhSachHoaDon();
  } else {
    alert("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.");
  }
}

function capNhatDanhSachHoaDon() {
  const ul = document.getElementById("danhSachHoaDon");
  ul.innerHTML = "";
  let tong = 0;
  hoaDonDaChon.forEach(kh => {
    const tongTien = Number(kh.TONG_NOP) + 2000;
    tong += tongTien;
    const li = document.createElement("li");
    li.innerText = `${kh.MA_KHTT} - ${kh.TEN_KHTT} | T·ªïng: ${formatVND(tongTien)}`;
    ul.appendChild(li);
  });
  document.getElementById("tongTienTatCa").innerText = formatVND(tong);
}

function inTatCaHoaDon() {
  if (hoaDonDaChon.length === 0) {
    alert("Ch∆∞a ch·ªçn h√≥a ƒë∆°n n√†o.");
    return;
  }

  let html = "";
  hoaDonDaChon.forEach(kh => {
    const nguoiThu = document.getElementById("nguoiThuTien").value || "-";
    const phi = 2000;
    const tong = Number(kh.TONG_NOP) + phi;
    const now = new Date();
    const ngay = now.toLocaleDateString('vi-VN');
    const gio = now.toTimeString().split(' ')[0];
    const thoiGian = `Ng√†y ${ngay}, Gi·ªù ${gio}`;

    html += `
      <div style="page-break-after: always;">
        <div style="text-align:center; font-weight:bold;">BI√äN LAI NH·∫¨N TI·ªÄN</div>
        <p>M√£ KH: ${kh.MA_KHTT}</p>
        <p>T√™n KH: ${kh.TEN_KHTT}</p>
        <p>S·ªë Ti·ªÅn: ${formatVND(kh.TONG_NOP)}</p>
        <p>Ph√≠: ${formatVND(phi)}</p>
        <p>T·ªïng Ti·ªÅn: ${formatVND(tong)}</p>
        <p>Ng∆∞·ªùi thu ti·ªÅn: ${nguoiThu}</p>
        <div style="text-align:center; font-weight:bold;">ƒê√É NH·∫¨N TI·ªÄN</div>
        <p>${thoiGian}</p>
      </div>
    `;

    lichSuIn.push({ maKH: kh.MA_KHTT, tenKH: kh.TEN_KHTT, soTien: tong, thoiGian: ngay });
    lichSuThu.push({ maKH: kh.MA_KHTT, tenKH: kh.TEN_KHTT, soTien: tong, thoiGian: ngay });
  });

  localStorage.setItem("lichSuIn", JSON.stringify(lichSuIn));
  localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));
  capNhatLichSu();

  const printArea = document.createElement("div");
  printArea.innerHTML = html;
  document.body.innerHTML = printArea.innerHTML;
  window.print();
  location.reload();
}

function capNhatLichSu() {
  document.getElementById("lichSuIn").value = lichSuIn.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  document.getElementById("lichSuThu").value = lichSuThu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
}

function xuatLichSu(loai) {
  const duLieu = loai === 'in' ? lichSuIn : lichSuThu;
  const text = duLieu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${item.soTien}`).join("\n");
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `lich_su_${loai}.txt`;
  a.click();
}

// ‚úÖ Xu·∫•t Excel g·ªìm 2 sheet: In & Thu
function xuatLichSuExcel() {
  const wb = XLSX.utils.book_new();

  const wsIn = XLSX.utils.json_to_sheet(lichSuIn.map(e => ({
    "M√£ KH": e.maKH, "T√™n KH": e.tenKH, "S·ªë Ti·ªÅn": e.soTien, "Th·ªùi Gian": e.thoiGian
  })));
  XLSX.utils.book_append_sheet(wb, wsIn, "L·ªãch S·ª≠ In");

  const wsThu = XLSX.utils.json_to_sheet(lichSuThu.map(e => ({
    "M√£ KH": e.maKH, "T√™n KH": e.tenKH, "S·ªë Ti·ªÅn": e.soTien, "Th·ªùi Gian": e.thoiGian
  })));
  XLSX.utils.book_append_sheet(wb, wsThu, "L·ªãch S·ª≠ Thu");

  XLSX.writeFile(wb, "lich_su.xlsx");
}

function xoaLichSu() {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ kh√¥ng?")) {
    localStorage.removeItem("lichSuIn");
    localStorage.removeItem("lichSuThu");
    lichSuIn = [];
    lichSuThu = [];
    capNhatLichSu();
  }
}

window.onload = capNhatLichSu;
</script>
</body>
</html>
